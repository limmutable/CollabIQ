# Data Model: LLM-Based Company Matching

**Feature**: Phase 2b - LLM-Based Company Matching
**Branch**: `007-llm-matching`
**Date**: 2025-11-02

## Overview

This document defines the data entities, relationships, and validation rules for Phase 2b company matching. The feature extends existing Phase 1b data models (`ExtractedEntities`) with new optional fields for matched company IDs and confidence scores.

---

## Entity Definitions

### 1. ExtractedEntities (Extended)

**Purpose**: Represents extracted email entities with optional company matching results

**Source**: `src/llm_provider/types.py` (Phase 1b base + Phase 2b extensions)

**Schema**:

```python
from pydantic import BaseModel, Field, validator
from typing import Optional

class ExtractedEntities(BaseModel):
    """
    Email entity extraction results with optional company matching.

    Phase 1b fields (existing - unchanged):
    - person_in_charge: Email contact person
    - startup_name: Primary startup/portfolio company name
    - partner_org: Beneficiary organization (SSG affiliate or another portfolio)
    - details: Collaboration details
    - date: Event date

    Phase 2b fields (new - optional for backward compatibility):
    - matched_company_id: Notion page ID for matched startup
    - matched_partner_id: Notion page ID for matched partner
    - startup_match_confidence: Confidence score for startup match (0.0-1.0)
    - partner_match_confidence: Confidence score for partner match (0.0-1.0)
    """

    # Phase 1b fields (existing)
    person_in_charge: Optional[str] = Field(
        None,
        description="Name of person in charge mentioned in email",
        example="김철수"
    )
    startup_name: Optional[str] = Field(
        None,
        description="Primary startup/portfolio company name",
        example="브레이크앤컴퍼니"
    )
    partner_org: Optional[str] = Field(
        None,
        description="Beneficiary organization (SSG affiliate or portfolio)",
        example="신세계푸드"
    )
    details: Optional[str] = Field(
        None,
        description="Collaboration details and context",
        example="파일럿 킥오프 미팅, 테이블 예약 시스템 통합 논의"
    )
    date: Optional[str] = Field(
        None,
        description="Event date in ISO 8601 format (YYYY-MM-DD)",
        example="2025-11-01"
    )

    # Phase 2b fields (new - optional)
    matched_company_id: Optional[str] = Field(
        None,
        description="Notion page ID for matched startup (32-character UUID)",
        example="abc123def456ghi789jkl012mno345"
    )
    matched_partner_id: Optional[str] = Field(
        None,
        description="Notion page ID for matched partner (32-character UUID)",
        example="pqr678stu901vwx234yz056abc123"
    )
    startup_match_confidence: Optional[float] = Field(
        None,
        ge=0.0,
        le=1.0,
        description="Confidence score for startup match (0.0-1.0)",
        example=0.95
    )
    partner_match_confidence: Optional[float] = Field(
        None,
        ge=0.0,
        le=1.0,
        description="Confidence score for partner match (0.0-1.0)",
        example=0.92
    )

    @validator('startup_match_confidence', 'partner_match_confidence')
    def validate_confidence_range(cls, v):
        """Ensure confidence scores are in valid range [0.0, 1.0]."""
        if v is not None and not (0.0 <= v <= 1.0):
            raise ValueError(f"Confidence must be between 0.0 and 1.0, got {v}")
        return v

    @validator('matched_company_id', 'matched_partner_id')
    def validate_notion_page_id_format(cls, v):
        """Validate Notion page ID format (32-character hex string or UUID)."""
        if v is not None and len(v) not in (32, 36):  # 32-char UUID or 36-char with hyphens
            raise ValueError(f"Invalid Notion page ID format: {v}")
        return v

    class Config:
        json_schema_extra = {
            "example": {
                "person_in_charge": "김철수",
                "startup_name": "브레이크앤컴퍼니",
                "partner_org": "신세계",
                "details": "파일럿 킥오프 미팅",
                "date": "2025-11-01",
                "matched_company_id": "abc123def456ghi789jkl012mno345",
                "matched_partner_id": "pqr678stu901vwx234yz056abc123",
                "startup_match_confidence": 0.95,
                "partner_match_confidence": 0.92
            }
        }
```

**Validation Rules**:
1. All Phase 2b fields are optional (backward compatibility with Phase 1b)
2. Confidence scores must be in range [0.0, 1.0]
3. Notion page IDs must be 32-character (UUID without hyphens) or 36-character (UUID with hyphens)
4. If `matched_company_id` is not null, `startup_match_confidence` should not be null
5. If `matched_partner_id` is not null, `partner_match_confidence` should not be null

---

### 2. CompanyContext

**Purpose**: Formatted company list for LLM prompt injection

**Source**: Generated by `NotionIntegrator.format_for_llm()` (Phase 2a)

**Schema** (Conceptual - not a Pydantic model, just markdown string):

```markdown
## Portfolio Companies

- 브레이크앤컴퍼니 (Break & Company, ID: abc123) - AI 재고 최적화 솔루션
- 웨이크 (Wake, ID: def456) - Z세대 뷰티 플랫폼
- 스위트스팟 (Sweet Spot, ID: ghi789) - 골프 예약 앱
- 블룸에이아이 (Bloom AI, ID: jkl012) - 생성형 AI 플랫폼
- 파지티브호텔 (Positive Hotel, ID: mno345) - 호텔 운영 최적화
- 스마트푸드네트워크 (Smart Food Network, ID: pqr678) - 식자재 유통

## SSG Affiliates

- 신세계 (Shinsegae, ID: stu901) - 백화점 및 유통
- 신세계인터내셔널 (Shinsegae International, ID: vwx234) - 패션 브랜드
- 신세계푸드 (Shinsegae Food, ID: yz056) - 식품 유통
- 신세계라이브쇼핑 (Shinsegae Live Shopping, ID: abc789) - 라이브 커머스
```

**Properties**:
- **Format**: Markdown with hierarchical sections (## headers)
- **Structure**: Grouped by classification (Portfolio vs SSG Affiliate)
- **Per-company**: Name (Korean), English name (if available), Notion ID, brief description
- **Token budget**: ≤2000 tokens (≤500 tokens for 10 test companies)

**Usage**: Injected into Gemini prompt as static context before email text

---

## Relationships

### ExtractedEntities ↔ Notion Companies Database

**Relationship**: Many-to-One (many emails reference same company)

```
ExtractedEntities.matched_company_id → Notion Companies.id (page ID)
ExtractedEntities.matched_partner_id → Notion Companies.id (page ID)
```

**Cardinality**:
- One email → 0-1 matched startup (null if no confident match)
- One email → 0-1 matched partner (null if no confident match)
- One Notion company → Many emails (one company appears in multiple collaborations)

**Referential Integrity**:
- Phase 2b: Read-only reference (no foreign key constraints)
- Phase 2d: Will create relation links in Notion CollabIQ database

---

## State Transitions

### Confidence Score States

```
┌─────────────────────┐
│  No Match Attempted │  (company_context=None → matched_id=None, confidence=None)
│  (Phase 1b mode)    │
└─────────────────────┘
          │
          │ company_context provided
          ▼
┌─────────────────────┐
│   LLM Matching      │  (Gemini evaluates semantic similarity)
└─────────────────────┘
          │
          ├───────────────────┬───────────────────┬───────────────────┐
          │                   │                   │                   │
          ▼                   ▼                   ▼                   ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  Exact Match     │  │  Semantic Match  │  │  Weak Match      │  │  No Match        │
│  confidence≥0.90 │  │  0.70≤conf<0.90  │  │  0.50≤conf<0.70  │  │  confidence<0.50 │
│                  │  │                  │  │                  │  │                  │
│  matched_id: ID  │  │  matched_id: ID  │  │  matched_id:null │  │  matched_id:null │
│  Auto-accept ✅  │  │  Auto-accept ✅  │  │  Manual review⚠️ │  │  Manual review⚠️ │
└──────────────────┘  └──────────────────┘  └──────────────────┘  └──────────────────┘
          │                   │                   │                   │
          └───────────────────┴───────────────────┴───────────────────┘
                                        │
                                        ▼
                               ┌─────────────────────┐
                               │  JSON Output Saved  │  (data/extractions/{id}.json)
                               └─────────────────────┘
```

**State Rules**:
1. **No Match Attempted**: Phase 1b backward compatibility mode (no company_context provided)
2. **Exact Match** (≥0.90): Auto-accepted, ready for Phase 2c classification
3. **Semantic Match** (0.70-0.89): Auto-accepted but may need manual verification
4. **Weak Match** (<0.70): Returns null, requires manual intervention (Phase 3a queue)
5. **No Match** (<0.50): Returns null, likely new company (see Technical Debt TD-001)

---

## Data Flow

### End-to-End Data Flow

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 1. Email Ingestion (Phase 1a)                                                   │
│    Gmail API → data/raw/{YYYY}/{MM}/{email_id}.json                             │
└──────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 2. Notion Company Fetch (Phase 2a)                                              │
│    NotionIntegrator.get_data(companies_db_id)                                   │
│    → data/notion_cache/{db_id}_data.json (6h TTL)                               │
│    → format_for_llm() → CompanyContext (markdown string)                        │
└──────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 3. LLM Extraction + Matching (Phase 2b - THIS PHASE)                            │
│    GeminiAdapter.extract_entities(email_text, company_context)                  │
│    → Single Gemini API call with structured JSON output                         │
│    → ExtractedEntities(matched_company_id, startup_match_confidence, ...)       │
└──────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 4. JSON Output (Phase 1b + Phase 2b combined)                                   │
│    data/extractions/{email_id}.json (contains all fields)                       │
└──────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 5. Future Phases (Phase 2c → 2d → 3a)                                           │
│    Phase 2c: Classification using matched IDs                                   │
│    Phase 2d: Notion write using matched IDs as relation links                   │
│    Phase 3a: Manual review queue for low-confidence matches                     │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## Example Data Instances

### Example 1: Exact Match (High Confidence)

**Input**: sample-001.txt
```
보낸사람: Giseon Teddy.Lee <ks.lee@break.co.kr>
제목: 브레이크앤컴퍼니 x 신세계 PoC 킥오프 결과
```

**CompanyContext** (from Phase 2a):
```markdown
## Portfolio Companies
- 브레이크앤컴퍼니 (Break & Company, ID: abc123def456) - AI 재고 최적화
```

**Output**: ExtractedEntities
```json
{
  "person_in_charge": "이기선",
  "startup_name": "브레이크앤컴퍼니",
  "partner_org": "신세계",
  "details": "PoC 킥오프 미팅, AI 재고 최적화 솔루션 데모",
  "date": "2025-10-28",
  "matched_company_id": "abc123def456",
  "matched_partner_id": "stu901vwx234",
  "startup_match_confidence": 0.98,
  "partner_match_confidence": 0.95
}
```

---

### Example 2: Semantic Match (Moderate Confidence)

**Input**: test email with abbreviation
```
SSG푸드와 TableManager 레스토랑 예약 시스템 도입 협의
```

**CompanyContext**:
```markdown
## SSG Affiliates
- 신세계푸드 (Shinsegae Food, ID: yz056abc123) - 식품 유통
```

**Output**: ExtractedEntities
```json
{
  "person_in_charge": null,
  "startup_name": "TableManager",
  "partner_org": "SSG푸드",
  "details": "레스토랑 예약 시스템 도입 협의",
  "date": null,
  "matched_company_id": null,
  "matched_partner_id": "yz056abc123",
  "startup_match_confidence": null,
  "partner_match_confidence": 0.82
}
```

**Note**: "SSG푸드" matched to "신세계푸드" via abbreviation understanding (confidence 0.82)

---

### Example 3: No Match (Low Confidence)

**Input**: test email with unknown company
```
CryptoStartup과 협업 논의 시작
```

**CompanyContext**:
```markdown
## Portfolio Companies
- (no matching entries for "CryptoStartup")
```

**Output**: ExtractedEntities
```json
{
  "person_in_charge": null,
  "startup_name": "CryptoStartup",
  "partner_org": null,
  "details": "협업 논의 시작",
  "date": null,
  "matched_company_id": null,
  "matched_partner_id": null,
  "startup_match_confidence": 0.42,
  "partner_match_confidence": null
}
```

**Note**: Low confidence (0.42) returns null for matched_company_id (US4 acceptance scenario)

---

## Validation Examples

### Valid Cases ✅

```python
# Case 1: Phase 1b mode (no matching)
ExtractedEntities(
    person_in_charge="김철수",
    startup_name="본봄",
    partner_org="신세계",
    details="파일럿 킥오프",
    date="2025-11-01"
    # All Phase 2b fields default to None
)

# Case 2: Phase 2b with matching
ExtractedEntities(
    person_in_charge="김철수",
    startup_name="본봄",
    partner_org="신세계",
    details="파일럿 킥오프",
    date="2025-11-01",
    matched_company_id="abc123",
    matched_partner_id="def456",
    startup_match_confidence=0.95,
    partner_match_confidence=0.92
)

# Case 3: No match scenario (null IDs with low confidence)
ExtractedEntities(
    person_in_charge=None,
    startup_name="UnknownCorp",
    partner_org=None,
    details="협업 제안",
    date=None,
    matched_company_id=None,
    matched_partner_id=None,
    startup_match_confidence=0.38,
    partner_match_confidence=None
)
```

### Invalid Cases ❌

```python
# Case 1: Confidence out of range
ExtractedEntities(
    startup_name="본봄",
    matched_company_id="abc123",
    startup_match_confidence=1.5  # ❌ Must be ≤1.0
)
# Raises: ValueError: Confidence must be between 0.0 and 1.0

# Case 2: Invalid Notion page ID format
ExtractedEntities(
    startup_name="본봄",
    matched_company_id="abc"  # ❌ Too short (must be 32 or 36 chars)
)
# Raises: ValueError: Invalid Notion page ID format

# Case 3: Mismatched nullability (matched ID but no confidence)
# This is allowed by schema but semantically inconsistent
# Should be caught by business logic tests
ExtractedEntities(
    startup_name="본봄",
    matched_company_id="abc123",
    startup_match_confidence=None  # ⚠️ Semantically inconsistent
)
```

---

## Migration Path (Backward Compatibility)

### Phase 1b → Phase 2b Migration

**Existing Phase 1b JSON files remain valid**:

```json
// Phase 1b output (no matched IDs)
{
  "person_in_charge": "김철수",
  "startup_name": "본봄",
  "partner_org": "신세계",
  "details": "파일럿 킥오프",
  "date": "2025-11-01"
}

// Loads successfully as ExtractedEntities with default None for Phase 2b fields
```

**Phase 2b output includes new fields**:

```json
// Phase 2b output (with matched IDs)
{
  "person_in_charge": "김철수",
  "startup_name": "본봄",
  "partner_org": "신세계",
  "details": "파일럿 킥오프",
  "date": "2025-11-01",
  "matched_company_id": "abc123def456ghi789jkl012mno345",
  "matched_partner_id": "pqr678stu901vwx234yz056abc123",
  "startup_match_confidence": 0.95,
  "partner_match_confidence": 0.92
}
```

**No breaking changes** - All existing code continues to work.

---

## Summary

**Data model design complete**:
- ✅ Extended ExtractedEntities with 4 new optional fields
- ✅ Backward compatible with Phase 1b (all new fields Optional[T] = None)
- ✅ Validation rules for confidence scores (0.0-1.0) and Notion IDs (32/36 chars)
- ✅ Clear state transitions from no-match → exact → semantic → weak → no-match
- ✅ Example data instances for all scenarios (exact, semantic, no-match)

**Next artifact**: Generate contracts/ (interface specifications for extended GeminiAdapter)
