# Implementation Plan: Email Reception and Normalization

**Branch**: `002-email-reception` | **Date**: 2025-10-30 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-email-reception/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command and defines the technical implementation strategy for Phase 1a.

## Summary

Implement EmailReceiver component to ingest emails from portfolioupdates@signite.co inbox and ContentNormalizer to clean email text by removing signatures, quoted threads, and disclaimers. This establishes the foundation for the CollabIQ system's collaboration tracking pipeline. Email infrastructure approach (IMAP, Gmail API, or webhook) will be selected based on Phase 0 research findings. Cleaned email text will be saved to file storage for downstream LLM processing in Phase 1b.

## Technical Context

**Language/Version**: Python 3.12
**Primary Dependencies**: ✅ **RESOLVED** - google-api-python-client (Gmail API), google-auth (OAuth2), google-cloud-pubsub (webhooks), pydantic-settings (config)
**Storage**: File system (JSON files for raw/cleaned emails)
**Testing**: pytest, pytest-mock, pytest-asyncio
**Target Platform**: Linux/macOS server (GCP Cloud Run deployment target)
**Project Type**: Single project (backend service)
**Performance Goals**: Process 50 emails in 10 minutes (12 sec/email average), retrieve emails within 5 minutes of arrival
**Constraints**: 95% signature/quote removal accuracy, 90% email retrieval success rate, exponential backoff retry (max 3 retries)
**Scale/Scope**: ~50 emails/day baseline with occasional spikes, support Korean and English email content

**Key Unknowns (Phase 0 Research)**: ✅ **ALL RESOLVED** (see [research.md](research.md))
1. **Email Infrastructure Choice**: ✅ **Gmail API + Cloud Pub/Sub Webhook** - Real-time push notifications for < 5 minute retrieval (SC-001)
2. **Signature Detection Patterns**: ✅ **Custom regex patterns** - Korean (감사합니다, 드림, 올림) and English (Best regards, Sincerely) patterns with heuristic fallback
3. **File Storage Structure**: ✅ **Monthly directories** - `data/raw/YYYY/MM/` with `YYYYMMDD_HHMMSS_{message_id}.json` naming
4. **Duplicate Detection Strategy**: ✅ **Message-ID tracking** - Lightweight JSON file `data/metadata/processed_ids.json`

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Specification-First Development
**Status**: ✅ PASS
- Specification exists: [spec.md](spec.md)
- User scenarios defined with acceptance criteria (4 user stories, P1-P3)
- Functional requirements documented (FR-001 through FR-012)
- Success criteria defined (SC-001 through SC-007)
- Specification is technology-agnostic

### Principle II: Incremental Delivery via Independent User Stories
**Status**: ✅ PASS
- User stories prioritized: P1 (email reception), P2 (signature/quote removal), P3 (disclaimer removal)
- P1 story is independently testable and constitutes an MVP (email ingestion pipeline)
- Each story can be demonstrated independently
- Implementation will proceed in priority order (P1 → P2 → P3)

### Principle III: Test-Driven Development (TDD)
**Status**: ✅ PASS (Tests Required)
- Feature specification explicitly requires unit tests for ContentNormalizer
- Test requirements documented in spec: signature removal, quote stripping
- Success criteria require measurable accuracy (95% for signature removal)
- TDD will be mandatory for this feature
- Tests will be written before implementation (red-green-refactor)

### Principle IV: Design Artifact Completeness
**Status**: ✅ PASS
- ✅ plan.md created (technical context, structure, constitution check)
- ✅ research.md generated (Phase 0: email infrastructure, patterns, storage, deduplication)
- ✅ data-model.md generated (Phase 1: RawEmail, CleanedEmail, ProcessingLog, DuplicateTracker Pydantic models)
- ✅ contracts/email_receiver.yaml generated (Phase 1: EmailReceiver interface, GmailWebhookReceiver implementation)
- ✅ contracts/content_normalizer.yaml generated (Phase 1: ContentNormalizer interface with Korean/English patterns)
- ✅ quickstart.md generated (Phase 1: setup guide, Gmail API OAuth2, Cloud Pub/Sub, testing, deployment)
- ✅ **ALL ARTIFACTS COMPLETE** - Ready for task generation (/speckit.tasks)

### Principle V: Simplicity & Justification
**Status**: ✅ PASS
- Solution is minimal: EmailReceiver + ContentNormalizer
- No unnecessary abstractions or frameworks
- File-based storage is simplest approach for this phase (no database needed)
- Pattern-based signature detection is simplest approach (no ML/AI complexity)
- No complexity violations identified

**Gate Result (Initial)**: ✅ **PASS** - Proceeded to Phase 0 research
**Gate Result (Post-Design)**: ✅ **PASS** - All principles validated, ready for implementation

## Project Structure

### Documentation (this feature)

```text
specs/002-email-reception/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
│   ├── email_receiver.yaml
│   └── content_normalizer.yaml
├── checklists/          # Quality validation
│   └── requirements.md
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── email_receiver/           # NEW: Email ingestion component
│   ├── __init__.py
│   ├── base.py              # EmailReceiver abstract interface
│   ├── imap_receiver.py     # IMAP implementation (if chosen)
│   ├── gmail_receiver.py    # Gmail API implementation (if chosen)
│   └── webhook_receiver.py  # Webhook implementation (if chosen)
│
├── content_normalizer/       # NEW: Email cleaning component
│   ├── __init__.py
│   ├── normalizer.py        # ContentNormalizer main class
│   ├── patterns.py          # Signature/disclaimer/quote patterns
│   └── utils.py             # Helper functions
│
├── models/                   # NEW: Data models
│   ├── __init__.py
│   ├── raw_email.py         # RawEmail Pydantic model
│   └── cleaned_email.py     # CleanedEmail Pydantic model
│
└── [existing]/
    ├── llm_provider/         # Phase 1b (future)
    ├── notion_integrator/    # Phase 2 (future)
    └── config/               # Existing: Pydantic settings

tests/
├── unit/
│   ├── test_content_normalizer.py     # NEW: ContentNormalizer unit tests
│   └── test_email_patterns.py         # NEW: Pattern matching tests
│
├── integration/
│   ├── test_email_receiver_imap.py    # NEW: IMAP integration tests
│   ├── test_email_receiver_gmail.py   # NEW: Gmail API integration tests (if chosen)
│   └── test_end_to_end_email.py       # NEW: Full pipeline test
│
└── fixtures/
    └── sample_emails/                  # NEW: Test email samples
        ├── korean_signature.txt
        ├── english_signature.txt
        ├── quoted_thread.txt
        └── disclaimer.txt

data/                         # NEW: File storage for emails
├── raw/                      # Raw email files (timestamp_messageid.json)
└── cleaned/                  # Cleaned email files (timestamp_messageid.json)
```

**Structure Decision**: Single project structure is appropriate. This is a backend service component that will integrate with other CollabIQ components (LLMProvider, NotionIntegrator) in future phases. No frontend needed for Phase 1a.

## Complexity Tracking

> **No violations** - All constitution principles pass without justification needed.

The solution follows the simplest possible approach:
- File-based storage (no database overhead)
- Pattern-based text cleaning (no ML complexity)
- Abstract interface with concrete implementations (standard Python pattern)
- Single responsibility components (EmailReceiver, ContentNormalizer)

---

## Planning Phase Completion Summary

### Phase 0: Research ✅ COMPLETE

**Completed**: 2025-10-30
**Artifacts**: [research.md](research.md)

**Key Decisions**:
1. **Email Infrastructure**: Gmail API + Cloud Pub/Sub Webhook (push notifications)
2. **Signature Patterns**: Custom regex library (Korean: 감사합니다, 드림; English: Best regards, Sincerely)
3. **File Storage**: Monthly directories (`data/raw/YYYY/MM/`, `data/cleaned/YYYY/MM/`)
4. **Duplicate Detection**: Message-ID tracking in `data/metadata/processed_ids.json`

**Impact**: All technical unknowns resolved. Design phase can proceed with confidence.

---

### Phase 1: Design & Contracts ✅ COMPLETE

**Completed**: 2025-10-30
**Artifacts**:
- [data-model.md](data-model.md) - Pydantic models (RawEmail, CleanedEmail, ProcessingLog, DuplicateTracker)
- [contracts/email_receiver.yaml](contracts/email_receiver.yaml) - EmailReceiver interface, GmailWebhookReceiver implementation
- [contracts/content_normalizer.yaml](contracts/content_normalizer.yaml) - ContentNormalizer interface with pattern library
- [quickstart.md](quickstart.md) - Setup guide (Gmail API OAuth2, Cloud Pub/Sub, deployment)

**Key Design Decisions**:
1. **Data Models**: Pydantic for type-safe validation with comprehensive field-level rules
2. **EmailReceiver**: Abstract base class with GmailWebhookReceiver concrete implementation
3. **ContentNormalizer**: Three-stage cleaning (disclaimers → quotes → signatures) for correctness
4. **Error Handling**: Exponential backoff with error codes (CONNECTION_FAILED, AUTHENTICATION_FAILED, RATE_LIMIT_EXCEEDED)
5. **Testing Strategy**: Unit tests (95% coverage target), integration tests (Gmail API), accuracy tests (95% removal target)

**Impact**: Complete API contracts enable parallel development of EmailReceiver and ContentNormalizer components.

---

### Next Phase: Task Generation

**Command**: `/speckit.tasks`
**Expected Output**: [tasks.md](tasks.md)

**Task Breakdown Preview**:
1. Implement RawEmail and CleanedEmail Pydantic models (TDD)
2. Implement EmailReceiver abstract interface
3. Implement GmailWebhookReceiver with OAuth2 flow (TDD)
4. Implement ContentNormalizer with pattern library (TDD)
5. Implement duplicate detection (DuplicateTracker)
6. Implement Gmail watch setup and Pub/Sub subscription
7. Write accuracy validation tests (SC-002, SC-003)
8. Create Cloud Run deployment configuration
9. End-to-end integration testing

**Estimated Timeline**: 3-4 days (per implementation-roadmap.md Phase 1a)

---

**Planning Status**: ✅ **COMPLETE** - All design artifacts generated and validated
**Ready For**: Task generation → Implementation → Testing → Deployment
