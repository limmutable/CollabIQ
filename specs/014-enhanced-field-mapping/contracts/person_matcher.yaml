openapi: 3.0.3
info:
  title: PersonMatcher API Contract
  description: |
    Service contract for matching extracted person names to Notion workspace users.

    This service enables field population for the people field (담당자) by matching
    person names to Notion user UUIDs with ambiguity detection and caching.
  version: 1.0.0
  contact:
    name: CollabIQ Development Team
    email: jlim@prorata.vc

paths:
  /match:
    post:
      summary: Match person name to Notion workspace users
      description: |
        Performs fuzzy string matching to find the best user match in the Notion workspace.

        **Matching Logic**:
        1. Load user list from cache (or fetch if stale/missing)
        2. Search for exact match (case-sensitive) → return immediately with similarity 1.0
        3. Compute Jaro-Winkler similarity for all users
        4. If best match ≥ 0.70 → return PersonMatch with user_id
        5. Check for ambiguity (multiple users with similar scores)
        6. If best match < 0.70 → return PersonMatch with no user_id

        **No auto-creation** - Unlike companies, persons are NOT created automatically.
        If no match found, the 담당자 field is left empty.

        **Performance**: Must complete in <1 second.
      operationId: matchPerson
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - person_name
              properties:
                person_name:
                  type: string
                  description: Extracted person name from LLM (may be Korean, English, or mixed)
                  example: "김철수"
                  minLength: 1
                  maxLength: 100
                similarity_threshold:
                  type: number
                  format: float
                  description: Minimum similarity score for match (default 0.70)
                  default: 0.70
                  minimum: 0.0
                  maximum: 1.0
                  example: 0.70
                include_alternatives:
                  type: boolean
                  description: Whether to include alternative matches in response (default true)
                  default: true
                  example: true
      responses:
        '200':
          description: Person match result (success or no match)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonMatch'
              examples:
                exactMatch:
                  summary: Exact match found
                  value:
                    user_id: "user-uuid-123"
                    user_name: "김철수 (Cheolsu Kim)"
                    similarity_score: 1.0
                    match_type: "exact"
                    confidence_level: "high"
                    is_ambiguous: false
                    alternative_matches: []
                fuzzyMatch:
                  summary: Fuzzy match found (similarity ≥ 0.70)
                  value:
                    user_id: "user-uuid-456"
                    user_name: "이영희 (Younghee Lee)"
                    similarity_score: 0.82
                    match_type: "fuzzy"
                    confidence_level: "medium"
                    is_ambiguous: false
                    alternative_matches: []
                ambiguousMatch:
                  summary: Multiple similar matches (ambiguous)
                  value:
                    user_id: "user-uuid-789"
                    user_name: "김민수 (Minsu Kim)"
                    similarity_score: 0.75
                    match_type: "fuzzy"
                    confidence_level: "low"
                    is_ambiguous: true
                    alternative_matches:
                      - user_id: "user-uuid-790"
                        user_name: "김민지 (Minji Kim)"
                        similarity_score: 0.73
                noMatch:
                  summary: No match found (similarity < 0.70)
                  value:
                    user_id: null
                    user_name: null
                    similarity_score: 0.45
                    match_type: "none"
                    confidence_level: "none"
                    is_ambiguous: false
                    alternative_matches: []
        '400':
          description: Invalid input (empty person name, invalid threshold)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error_code: "INVALID_INPUT"
                message: "person_name must be non-empty"
                details: {"field": "person_name", "value": ""}
        '429':
          description: Notion API rate limit exceeded (only on cache refresh)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error_code: "RATE_LIMIT_EXCEEDED"
                message: "Notion API rate limit exceeded while fetching users"
                details: {"retry_after_seconds": 1}
        '500':
          description: Internal server error (cache read/write error, matching algorithm error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error_code: "CACHE_ERROR"
                message: "Failed to read user list cache"
                details: {"cache_path": "data/notion_cache/users_list.json"}

  /list-users:
    get:
      summary: List all Notion workspace users
      description: |
        Returns cached user list or fetches from Notion API if cache is stale.

        **Caching**: User list cached for 24 hours (TTL 86400 seconds).
        Cache location: `data/notion_cache/users_list.json`

        **Use Case**: CLI command `collabiq notion list-users` for admin inspection.
      operationId: listUsers
      parameters:
        - name: refresh
          in: query
          description: Force refresh from Notion API (bypass cache)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of Notion workspace users
          content:
            application/json:
              schema:
                type: object
                required:
                  - users
                  - cached_at
                  - cache_status
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/NotionUser'
                  cached_at:
                    type: string
                    format: date-time
                    description: Timestamp when cache was last updated
                    example: "2025-11-10T10:30:00Z"
                  cache_status:
                    type: string
                    enum: ["fresh", "stale", "refreshed"]
                    description: |
                      Cache status:
                      - fresh: cache valid and used
                      - stale: cache expired, refreshed from API
                      - refreshed: forced refresh via ?refresh=true
                    example: "fresh"
              example:
                users:
                  - id: "user-uuid-123"
                    name: "김철수 (Cheolsu Kim)"
                    email: "cheolsu@example.com"
                    type: "person"
                  - id: "user-uuid-456"
                    name: "이영희 (Younghee Lee)"
                    email: "younghee@example.com"
                    type: "person"
                cached_at: "2025-11-10T10:30:00Z"
                cache_status: "fresh"
        '429':
          description: Notion API rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    PersonMatch:
      type: object
      required:
        - user_id
        - user_name
        - similarity_score
        - match_type
        - confidence_level
        - is_ambiguous
        - alternative_matches
      properties:
        user_id:
          type: string
          nullable: true
          description: Notion user UUID (null if no match)
          example: "user-uuid-123"
          pattern: '^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$'
        user_name:
          type: string
          nullable: true
          description: Full name of matched user (null if no match)
          example: "김철수 (Cheolsu Kim)"
        similarity_score:
          type: number
          format: float
          description: Name similarity score (0.0-1.0)
          minimum: 0.0
          maximum: 1.0
          example: 0.82
        match_type:
          type: string
          enum: ["exact", "fuzzy", "none"]
          description: |
            How the match was determined:
            - exact: name matched exactly (similarity 1.0)
            - fuzzy: name matched with similarity ≥ threshold
            - none: no match found (similarity < threshold)
          example: "fuzzy"
        confidence_level:
          type: string
          enum: ["high", "medium", "low", "none"]
          description: |
            Confidence in the match:
            - high: similarity ≥ 0.90 and not ambiguous
            - medium: 0.80 ≤ similarity < 0.90 or ambiguous with high score
            - low: 0.70 ≤ similarity < 0.80
            - none: similarity < 0.70
          example: "medium"
        is_ambiguous:
          type: boolean
          description: |
            Whether multiple users had similar scores (difference < 0.10).
            Ambiguous matches are logged for manual review.
          example: false
        alternative_matches:
          type: array
          description: Other potential matches (if ambiguous or requested)
          items:
            type: object
            required:
              - user_id
              - user_name
              - similarity_score
            properties:
              user_id:
                type: string
                example: "user-uuid-456"
              user_name:
                type: string
                example: "김민지 (Minji Kim)"
              similarity_score:
                type: number
                format: float
                example: 0.73
          example: []

    NotionUser:
      type: object
      required:
        - id
        - name
        - type
      properties:
        id:
          type: string
          description: Notion user UUID
          example: "user-uuid-123"
          pattern: '^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$'
        name:
          type: string
          description: Full name as appears in Notion
          example: "김철수 (Cheolsu Kim)"
        email:
          type: string
          nullable: true
          description: Email address (if available)
          example: "cheolsu@example.com"
          format: email
        type:
          type: string
          enum: ["person", "bot"]
          description: User type (person or bot)
          example: "person"

    Error:
      type: object
      required:
        - error_code
        - message
      properties:
        error_code:
          type: string
          description: Machine-readable error code
          example: "INVALID_INPUT"
        message:
          type: string
          description: Human-readable error message
          example: "person_name must be non-empty"
        details:
          type: object
          description: Additional error context
          additionalProperties: true
          example: {"field": "person_name"}

tags:
  - name: matching
    description: Person name matching operations
  - name: users
    description: Notion workspace user management

externalDocs:
  description: Feature specification and data model
  url: ../spec.md

x-contract-tests:
  description: |
    Contract tests must verify:
    1. Exact match returns similarity 1.0 and match_type "exact"
    2. Fuzzy match with similarity ≥ 0.70 returns match_type "fuzzy" and valid user_id
    3. No match with similarity < 0.70 returns match_type "none" and user_id null
    4. Ambiguous matches (difference < 0.10) set is_ambiguous=true and populate alternative_matches
    5. Invalid input (empty string, invalid threshold) returns 400 error
    6. Performance: completes in <1 second
    7. Cache hit avoids Notion API call, cache miss fetches and stores

x-implementation-notes:
  algorithm: "Jaro-Winkler similarity via rapidfuzz library"
  normalization: "Minimal - trim whitespace only"
  caching: "User list cached in file for 24 hours (TTL 86400 seconds)"
  cache-location: "data/notion_cache/users_list.json"
  ambiguity-threshold: "0.10 - if top 2 scores differ by <0.10, mark ambiguous"
  korean-name-handling: "Full name matching (family + given name), no special tokenization"
  no-auto-creation: "Unlike companies, persons are NOT created automatically"
