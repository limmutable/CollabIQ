# Notion Workspace Users API Contract
# Phase 017 - Person Matching Enhancement

api_endpoint:
  name: List all users (workspace members)
  method: GET
  base_url: https://api.notion.com/v1
  path: /users
  authentication: Bearer token (Integration token)
  version: "2022-06-28"

request:
  headers:
    Authorization:
      required: true
      format: "Bearer {integration_token}"
      description: Notion integration token

    Notion-Version:
      required: true
      value: "2022-06-28"
      description: API version date

  query_parameters:
    start_cursor:
      type: string
      required: false
      description: Pagination cursor from previous response

    page_size:
      type: integer
      required: false
      default: 100
      max: 100
      description: Number of results per page

  body: null

response:
  success:
    status_code: 200
    content_type: application/json
    schema:
      object: string
      value: "list"

      results:
        type: array
        description: List of user objects
        items:
          object: string
          value: "user"

          id: string
          format: uuid
          description: User unique identifier (32 hex chars, no dashes)
          example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"

          type: string
          enum: ["person", "bot"]
          description: User type

          name: string
          description: User's display name (Korean or English)
          example: "김철수"

          avatar_url: string | null
          description: URL to user's avatar image

          person:
            type: object
            description: Person-specific fields (only for type="person")
            properties:
              email: string
              format: email
              description: User's email address

      has_more: boolean
      description: Whether there are more results

      next_cursor: string | null
      description: Cursor for next page (if has_more=true)

    example: |
      {
        "object": "list",
        "results": [
          {
            "object": "user",
            "id": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6",
            "type": "person",
            "name": "김철수",
            "avatar_url": "https://...",
            "person": {
              "email": "kim@example.com"
            }
          },
          {
            "object": "user",
            "id": "b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7",
            "type": "person",
            "name": "이영희",
            "avatar_url": null,
            "person": {
              "email": "lee@example.com"
            }
          }
        ],
        "has_more": false,
        "next_cursor": null
      }

  errors:
    - status_code: 400
      code: validation_error
      message: Invalid request parameters
      description: Request format is invalid

    - status_code: 401
      code: unauthorized
      message: API token is invalid
      description: Authorization header missing or invalid

    - status_code: 403
      code: restricted_resource
      message: Integration lacks permissions
      description: Integration does not have permission to read users

    - status_code: 429
      code: rate_limited
      message: Rate limit exceeded
      description: Too many requests, retry after specified duration
      retry_after_header: Retry-After (seconds)

    - status_code: 500
      code: internal_server_error
      message: Notion API error
      description: Temporary server error, retry with exponential backoff

rate_limits:
  requests_per_second: 3
  concurrent_requests: 3
  burst_limit: 3
  strategy: Exponential backoff on 429 errors

pagination:
  max_page_size: 100
  strategy: Cursor-based pagination
  implementation: |
    1. Make initial request without start_cursor
    2. If has_more=true, use next_cursor for subsequent request
    3. Continue until has_more=false

caching_strategy:
  cache_key: "notion:workspace_users:{workspace_id}"
  ttl: 24 hours
  invalidation: TTL-based (no manual invalidation)
  rationale: User list relatively stable (changes <1/day)

integration_requirements:
  permissions:
    - Read user information without email addresses
      scope: user:read

  workspace:
    type: Internal integration
    description: Must be created in workspace settings

filtering:
  filter_bots: true
  strategy: Filter out users where type="bot"
  rationale: Only match against real people, not Notion bots

error_handling:
  - error: 401 Unauthorized
    action: Log critical error, fail fast (invalid credentials)
    retry: false

  - error: 403 Forbidden
    action: Log error with permission instructions, fail fast
    retry: false

  - error: 429 Rate Limited
    action: Exponential backoff (1s, 2s, 4s, 8s)
    max_retries: 3
    requirements: [FR-033]

  - error: 500 Internal Server Error
    action: Exponential backoff (1s, 2s, 4s)
    max_retries: 3

  - error: Network timeout
    action: Retry with backoff
    timeout: 30 seconds
    max_retries: 2

test_scenarios:
  - name: Successfully fetch all workspace users
    given: Valid integration token with user:read permission
    when: GET /users request
    then: Return 200 with list of users, filter to type="person" only

  - name: Pagination with large user list
    given: Workspace with 150 users
    when: GET /users with page_size=100
    then: First request returns 100 users with has_more=true, second request returns 50 users

  - name: Rate limit handling
    given: Multiple rapid requests exceeding rate limit
    when: GET /users request
    then: Return 429, retry after exponential backoff

  - name: Invalid token
    given: Expired or invalid integration token
    when: GET /users request
    then: Return 401, log critical error, fail fast

  - name: Missing permissions
    given: Integration without user:read permission
    when: GET /users request
    then: Return 403, log error with instructions

requirements_mapping:
  - FR-001: Query Notion workspace users API
  - FR-002: Cache user list for 24 hours
  - FR-033: Respect API rate limits with exponential backoff

example_implementation:
  python: |
    from notion_client import Client
    from datetime import datetime, timedelta
    import json
    from pathlib import Path

    class NotionUserService:
        def __init__(self, token: str, cache_dir: Path):
            self.client = Client(auth=token)
            self.cache_dir = cache_dir
            self.cache_file = cache_dir / "workspace_users.json"

        def get_all_users(self, force_refresh: bool = False) -> List[NotionWorkspaceUser]:
            """Fetch all workspace users with 24-hour caching."""
            if not force_refresh and self._is_cache_valid():
                return self._load_from_cache()

            users = []
            has_more = True
            start_cursor = None

            while has_more:
                response = self.client.users.list(
                    start_cursor=start_cursor,
                    page_size=100
                )

                # Filter to persons only (exclude bots)
                persons = [
                    user for user in response["results"]
                    if user["type"] == "person"
                ]
                users.extend(persons)

                has_more = response["has_more"]
                start_cursor = response.get("next_cursor")

            self._save_to_cache(users)
            return users

        def _is_cache_valid(self) -> bool:
            if not self.cache_file.exists():
                return False
            cache_data = json.loads(self.cache_file.read_text())
            cached_at = datetime.fromisoformat(cache_data["cached_at"])
            ttl = timedelta(hours=24)
            return datetime.utcnow() < (cached_at + ttl)

references:
  - Official Notion API docs: https://developers.notion.com/reference/get-users
  - Notion API rate limits: https://developers.notion.com/reference/request-limits
  - Notion integration permissions: https://www.notion.so/help/add-and-manage-integrations
